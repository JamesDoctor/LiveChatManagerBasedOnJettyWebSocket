<html>
	<head>
		<meta charset="utf-8">
		<script type="text/javascript" src="scripts/jquery-3.1.1.js"></script>
		<link rel="stylesheet" href="css/customerLiveChat.css">
	</head>
	<body>
	    <H1>Hello, this is Customer!</H1>

		
		
		<!-- Start of LiveChat Widget in Customer side -->
		<div id="liveChat-Widget">
			<div id="liveChat-minimized">
				<div id="lc-content">
				    <a id="lc-full-view-button" class="lc-widget-header" href="#">
						<span id="lc-open-label">Chat with Customer Service</span>
					</a>
				</div>
			</div>
			<div id="liveChat-full">
				<div id="lc-wrapper" class="lc-outline">
					<table class="lc-content" cellspacing="0" cellpadding="0"><tbody>
						<tr id="lc-title-container"><td>
							<a id="lc-title-row" class="lc-widget-header" href="#">
								<span id="lc-close-chat" class="lc-title-button" data-title="Close the chat">x</span>	
								<span id="lc-minimize" class="lc-title-button" data-title="Minimize window">-</span>		
								<span id="lc-title-text">Customer Service</span>
							</a>					
						</td></tr>
						<tr id="lc-chat-container"><td>
							<div id="lc-chatRecords"></div>
						</td></tr>
						<tr id="lc-chat-control"><td>
						    <div id="lc-startChat-container">
								<input type="button" name="startChat" id="lc-startChat" value="Start Chat" class="lc-startChatBtn">
							</div>
						    <div id="lc-sendMessage-container">
								<div><input type="text" name="message" id="lc-message" class="lc-inputMessage"></div>
								<div><input type="button" name="sendMessage" id="lc-sendMessage" value="Send Message" class="lc-sendMessageBtn"></div>
							</div>
						</td></tr>
					</tbody></table>
				</div>		
			</div>
		</div>
		
		<!-- End of LiveChat Widget in Customer side -->
		
		<!-- Start of LiveChat code -->
		<script type="text/javascript">
			function setupLiveChat() {
				var ws = null;
				var chatBoxFullView = true;
				var selectors = {
					CHAT_RECORDS : "#lc-chatRecords",
					CHAT_MIN : "#liveChat-minimized",
					CHAT_FULL : "#liveChat-full",
					START_CHAT_CONTAINER : "#lc-startChat-container",
					SEND_MESSAGE_CONTAINER : "#lc-sendMessage-container",
					FULL_VIEW_BTN : "#lc-full-view-button",
					MIN_VIEW_BTN : "#lc-minimize",
					CLOSE_CHAT_BTN : "#lc-close-chat",
					START_CHAT_BTN : ".lc-startChatBtn",
					SEND_MSG_BTN : ".lc-sendMessageBtn",
					INPUT_MSG : ".lc-inputMessage"
				};
				
				var styles = {
					VISIBILITY : "visibility",
					VISIBLE : "visible",
					HIDDEN : "hidden"
				};
				
				function startCommunication() {
					if (ws) {
						return;
					}
					try {
						ws = new WebSocket("ws://localhost:8080/Customer/events?Company=ABCLtd"); 
					} catch (e) {
						appendChatRecord(e);
					}
					
					ws.onopen = function(){
						appendChatRecord("Connected to Customer Service.");
						toggleChatContoller();
					}; 
					ws.onmessage = function(evt){
						console.log(evt.data);
						appendChatRecord(evt.data);
					}; 
					ws.onclose = function(evt){
						ws = null;
						toggleChatContoller();
					}; 
					ws.onerror = function(evt){
						appendChatRecord("Error in communicating with Customer Service!");
					};
				}
				
				function stopCommunication() {
					if (!ws) {
						return;
					}
					ws.close();
				}
				
				function appendChatRecord(message) {
					if (message) {
						$(selectors.CHAT_RECORDS).append("<div class='lc-chatMessage'>" + message + "</div>");
						$(selectors.CHAT_RECORDS)[0].scrollTop = $(selectors.CHAT_RECORDS)[0].scrollHeight;
					}
				}
				
				function toggleWidget(fullView, minimizedView) {
					var fullViewStyle = fullView ? styles.VISIBLE : styles.HIDDEN;
					var minimizedViewStyle = minimizedView ? styles.VISIBLE : styles.HIDDEN;
					$(selectors.CHAT_MIN).css(styles.VISIBILITY, minimizedViewStyle);
					$(selectors.CHAT_FULL).css(styles.VISIBILITY, fullViewStyle);
				}
				
				function toggleChatContoller() {
					var startChatStyle = ((!ws) && chatBoxFullView) ? styles.VISIBLE : styles.HIDDEN;
					var sendMsgStyle = (ws && chatBoxFullView) ? styles.VISIBLE : styles.HIDDEN;
					$(selectors.START_CHAT_CONTAINER).css(styles.VISIBILITY, startChatStyle);
					$(selectors.SEND_MESSAGE_CONTAINER).css(styles.VISIBILITY, sendMsgStyle);
				}
				
				$(selectors.FULL_VIEW_BTN).on("click", function() {
					toggleWidget(true, false);
					chatBoxFullView = true;
					toggleChatContoller();
				});
				
				$(selectors.MIN_VIEW_BTN).on("click", function() {
					toggleWidget(false, true);
					chatBoxFullView = false;
					toggleChatContoller();
				});
				
				$(selectors.CLOSE_CHAT_BTN).on("click", function() {
					stopCommunication();
					toggleWidget(false, false);
					$(selectors.CHAT_MIN).remove();
					$(selectors.CHAT_FULL).remove();
				});
				
				$(selectors.START_CHAT_BTN).on("click", function() {
					startCommunication();
				});
				
				$(selectors.SEND_MSG_BTN).on("click", function() {
					var msg = $(selectors.INPUT_MSG)[0].value;
					if (msg) {
						ws.send(msg);
						appendChatRecord("Me: " + msg);
						$(selectors.INPUT_MSG)[0].value = "";
					}
				});
			}
			
			setupLiveChat();
		</script>
		<!-- End of LiveChat code -->
	</body>
</html>